name: Release Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version/tag to release (e.g. v1.2.3)"
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  build-packages:
    name: Build ${{ matrix.platform }} packages
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: windows
          - os: macos-latest
            platform: macos

    steps:
      - uses: actions/checkout@v4

      - name: Install Linux build dependencies (Bevy)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: bash pipelines/install_linux_deps.sh

      - name: Build (release)
        shell: bash
        run: bash pipelines/build_release.sh

      - name: Package (linux/macos)
        if: matrix.os != 'windows-latest'
        shell: bash
        run: >-
          bash pipelines/package.sh
          --version '${{ inputs.version }}'
          --platform '${{ matrix.platform }}'

      - name: Package (windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: >-
          pwsh -File pipelines/package_windows.ps1
          -Version '${{ inputs.version }}'
          -Platform '${{ matrix.platform }}'

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.platform }}
          path: dist/*.zip
          if-no-files-found: error

  create-github-release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    needs: build-packages
    permissions:
      contents: write

    steps:
      - name: Download all package artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create (or update) release and upload assets
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          VERSION='${{ inputs.version }}'

          mapfile -t FILES < <(find artifacts -type f -name '*.zip' -print)
          if [[ ${#FILES[@]} -eq 0 ]]; then
            echo "No .zip artifacts found to upload" >&2
            exit 1
          fi

          if gh release view "$VERSION" --repo "$GH_REPO" >/dev/null 2>&1; then
            gh release upload "$VERSION" "${FILES[@]}" --repo "$GH_REPO" --clobber
          else
            gh release create "$VERSION" "${FILES[@]}" --repo "$GH_REPO" \
              --title "$VERSION" \
              --target "${GITHUB_SHA}" \
              --notes "Automated release for $VERSION"
          fi
