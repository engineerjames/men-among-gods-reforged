services:
  certgen:
    image: bash:5.2
    command:
      - /bin/sh
      - -lc
      - apk add --no-cache openssl >/dev/null && ./scripts/generate_certs.sh --out /certs $${TLS_EXTRA_SAN:+--san "$${TLS_EXTRA_SAN}"}
    environment:
      TLS_EXTRA_SAN: ${TLS_EXTRA_SAN:-}
    volumes:
      - ./:/workspace:ro
      - tls-certs:/certs
    working_dir: /workspace
    restart: "no"

  keydb:
    image: eqalpha/keydb:latest
    command:
      - keydb-server
      - --port
      - "5556"
      - --requirepass
      - ${KEYDB_PASSWORD:?KEYDB_PASSWORD is required}
      - --appendonly
      - "yes"
      - --appendfsync
      - everysec
      - --save
      - "900"
      - "1"
      - "--server-threads"
      - "4"
    restart: unless-stopped
    volumes:
      - keydb-data:/data
    healthcheck:
      test: ["CMD-SHELL", "keydb-cli -p 5556 -a \"$${KEYDB_PASSWORD}\" ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    environment:
      KEYDB_PASSWORD: ${KEYDB_PASSWORD:?KEYDB_PASSWORD is required}

  server-seed:
    build:
      context: .
      dockerfile: server/Dockerfile
    depends_on:
      keydb:
        condition: service_healthy
    environment:
      MAG_KEYDB_URL: redis://:${KEYDB_PASSWORD:?KEYDB_PASSWORD is required}@keydb:5556/
    command:
      - /bin/sh
      - -lc
      - /app/dat-to-keydb --skip-if-seeded
    restart: "no"

  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    depends_on:
      certgen:
        condition: service_completed_successfully
      keydb:
        condition: service_healthy
    environment:
      API_JWT_SECRET: ${API_JWT_SECRET:?API_JWT_SECRET is required}
      API_BIND_ADDR: 0.0.0.0
      API_PORT: 5554
      MAG_KEYDB_URL: redis://:${KEYDB_PASSWORD:?KEYDB_PASSWORD is required}@keydb:5556/
      API_TLS_CERT: /certs/server.crt
      API_TLS_KEY: /certs/server.key
    volumes:
      - tls-certs:/certs:ro
    ports:
      - "5554:5554"
    restart: unless-stopped

  server:
    build:
      context: .
      dockerfile: server/Dockerfile
    depends_on:
      certgen:
        condition: service_completed_successfully
      keydb:
        condition: service_healthy
      server-seed:
        condition: service_completed_successfully
    environment:
      MAG_STORAGE_BACKEND: keydb
      MAG_KEYDB_URL: redis://:${KEYDB_PASSWORD:?KEYDB_PASSWORD is required}@keydb:5556/
      SERVER_TLS_CERT: /certs/server.crt
      SERVER_TLS_KEY: /certs/server.key
    volumes:
      - tls-certs:/certs:ro
    ports:
      - "5555:5555"
    stop_signal: SIGINT
    stop_grace_period: 2m
    restart: unless-stopped

volumes:
  keydb-data:
  tls-certs:
